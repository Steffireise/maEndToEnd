---
title: "MA end to tend workflow"
author: "Bernd Klaus"
output: 
    BiocStyle::html_document:
        toc: true
        highlight: tango
vignette: >
    %\VignetteIndexEntry{dummy workflow to trace genefinder bug}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}  
---


<!--
To compile this document
graphics.off();rm(list=ls());rmarkdown::render('dummy-Workflow.Rmd');
-->

```{r options, include=FALSE}
library(knitr)
options(digits=3, width=80)
opts_chunk$set(echo=TRUE,tidy=FALSE,include=TRUE,
               dev='png', fig.width = 6, fig.height = 3.5, comment = '  ', dpi = 300,
cache = TRUE)
```



# Required packages and other preparations




```{r required packages and data, echo = TRUE}
library(BiocStyle)
library(oligo)
library(geneplotter)
library(ggplot2)
library(dplyr)
library(LSD)
library(gplots)
library(RColorBrewer)
library(ArrayExpress)
library(arrayQualityMetrics)
library(stringr)
library(matrixStats)
library(topGO)
library(genefilter)
library(biomaRt)
library(pd.hugene.1.0.st.v1)
library(hugene10sttranscriptcluster.db)
library(pheatmap)
library(mvtnorm)
library(DAAG)
library(multcomp)
library(limma)
library(EnrichmentBrowser)
library(xlsx)
library(devtools)
library(biomaRt)

rawDataDir <- file.path(getwd(), "rawDataMAWorkflow")
```


# Download the raw data from from ArrayExpress

The first step of the analysis is to download the raw data CEL files. Theses files
are produced by the array scanner software and contain the probe intensities 
measured. The data has been deposited at [ArrayExpress](https://www.ebi.ac.uk/arrayexpress/)
and has the accession code **E-MTAB-2967**. This accession code is commonly
reported in the original publication. 

Each Array--Express data set has a landing page summarizing the data set, 
the one for our data is here:

* [Data fromPalmieri et. al. at ArrayEpress](https://www.ebi.ac.uk/arrayexpress/experiments/E-MTAB-2967/)

We use the `r Biocpkg("ArrayExpress") ` Bioconductor package to obtain the links to
download the raw data.

# Information stored in ArrayExpress

In the repository for each dataset ArrayExpress stores a MAGE-TAB document with standardized
format. A MAGE-TAB document contains upt to five different types of files
Investigation DescriptionFormat (IDF), Array Design Format (ADF),
Sample and Data Relationship Format (SDRF), the raw data files and
the processed data files.

The Investigation Description Format (IDF) file contains top level information
about the experiment including title, description, submitter contact details and
protocols. The SDRF (Sample and Data Relationship Format) file containes
the information on the samples. 



# Get the raw and the annotation data 

Wih the code below, we download the raw data from
[ArrayExpress](https://www.ebi.ac.uk/arrayexpress/).

It is saved in the directory **rawDataDir** which defaults to the current
working directory. The names of the downloaded files are returned as a list.

```{r getDataEBI, eval=TRUE }
rawDataDir <- rawDataDir

if(!dir.exists(rawDataDir)){

    dir.create(rawDataDir)
}

annoAE <- getAE("E-MTAB-2967", path=rawDataDir, type="raw")
```




```{r getSDRF}
SDRF <-  read.delim(url("http://www.ebi.ac.uk/arrayexpress/files/E-MTAB-2967/E-MTAB-2967.sdrf.txt"),
                    row.names = "Array.Data.File")
SDRF <- AnnotatedDataFrame(SDRF)
```



## Import of microarray data and initial quality control

### Importing CEL files


```{r importCelfiles, results="hide", eval=TRUE, dependson=c("getSDRF", "getDataEBI")}
celfolder <- rawDataDir
cels <- list.celfiles(path = celfolder, pattern="*.CEL")

rawData <- read.celfiles(filenames = file.path(rawDataDir, cels),
                         verbose = FALSE, phenoData = SDRF)

validObject(rawData)
```



```{r inspectPhenoData, results='hide', eval=TRUE, dependson="importCelfiles" }
head(pData(rawData))
head(exprs(rawData))
stopifnot(validObject(rawData))

pData(rawData) <- pData(rawData)[, c("Source.Name",
                                     "Characteristics.individual.",
                                     "Factor.Value.disease.",
                                     "Factor.Value.phenotype." )]
```



```{r RMAcalibration, eval=TRUE, dependson="inspectPhenoData"}
palmieriEset <- oligo::rma(rawData, target="core")

```





```{r excludeMultipleMappings, dependson="annotateData"}

PalmieriFinal <- palmieriEset

```


# Limma and Gene ontology enrichment analysis


```{r GOAnalysisCreateBackgrounds, eval=TRUE, warning=FALSE, dependson="excludeMultipleMappings"}

individual <- as.character(pData(PalmieriFinal)$Characteristics.individual.)

tissue <- str_replace_all(pData(PalmieriFinal)$Factor.Value.phenotype., " ", "_")
tissue <- ifelse(tissue == "non-inflamed_colonic_mucosa", "nI", "I")

disease <- str_replace_all(pData(PalmieriFinal)$Factor.Value.disease., " ", "_")
disease <- ifelse(disease == "Crohn's_disease", "C", "U")


i <- individual[disease == "C"]
designPalmieriC <- model.matrix(~ 0  + tissue[disease == "C"]
                                + i)
colnames(designPalmieriC)[1:2] <- c("I", "nI")


contrastMatrixC <- makeContrasts(I-nI, levels = designPalmieriC)

PalmieriFitC <- eBayes(contrasts.fit(lmFit(PalmieriFinal[,disease == "C"],
                                design = designPalmieriC),
                                contrastMatrixC))
tableC <-  topTable(PalmieriFitC, number = Inf)

DEgenesCD <- rownames(base::subset(tableC, adj.P.Val < 0.1))



message(paste0(as.character(DEgenesCD)[1:5], collapse = "--"))

backGIdx <- genefinder(PalmieriFinal, as.character(DEgenesCD)[1:5], 
                       method="manhattan", scale="none")

```







---
title: "MA end to tend workflow"
author: "Bernd Klaus"
output: 
    BiocStyle::html_document:
        toc: true
        highlight: tango
vignette: >
    %\VignetteIndexEntry{dummy workflow to trace genefinder bug}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}  
---


<!--
To compile this document
graphics.off();rm(list=ls());rmarkdown::render('dummy-Workflow.Rmd');
-->

```{r options, include=FALSE}
library(knitr)
options(digits=3, width=80)
opts_chunk$set(echo=TRUE,tidy=FALSE,include=TRUE,
               dev='png', fig.width = 6, fig.height = 3.5, comment = '  ', dpi = 300,
cache = FALSE)
```



# Required packages and other preparations




```{r required packages and data, echo = TRUE}
library(BiocStyle)
library(oligo)
library(geneplotter)
library(ggplot2)
library(dplyr)
library(LSD)
library(gplots)
library(RColorBrewer)
library(ArrayExpress)
library(arrayQualityMetrics)
library(stringr)
library(Biobase)
library(topGO)
library(genefilter)
library(xlsx)
library(ALL)
library(limma)

rawDataDir <- file.path(getwd(), "rawDataMAWorkflow")
```


# Gene ontology enrichment analysis
We can now try characterize the identified differentially expressed genes
a bit better by performing an GO enrichment analysis. Essentially the
gene ontology (\url{http://www.geneontology.org/}) is hierarchically organized
collection of functional gene sets. For a nice introduction to the GO see
[du Plessis et. al.](http://www.dx.doi.org/10.1093/bib/bbr002).

## Matching the background set

The function \Rfunction{genefinder} from the genefilter  will be used
to find background genes that are similar to the differentially expressed
genes. We then check whether the background has roughly the same distribution
of average expression strength as the foreground.

We do this in order not to select a biased background since the gene set testing
is performed by a simple Fisher test on a 2x2 table. Note that this appraoch
is very similar to web tools like DAVID. Here we focus on the  CD data.

For every differentially expressed gene, we try to find 5 genes with similar
expresssion.

```{r GOAnalysisCreateBackgrounds, eval=TRUE, dependson="extractResults", warning=FALSE}

load("PalmieriFinal.RData")
individual <- as.character(pData(PalmieriFinal)$Characteristics.individual.)

tissue <- str_replace_all(pData(PalmieriFinal)$Factor.Value.phenotype., " ", "_")
tissue <- ifelse(tissue == "non-inflamed_colonic_mucosa", "nI", "I")

disease <- str_replace_all(pData(PalmieriFinal)$Factor.Value.disease., " ", "_")
disease <- ifelse(disease == "Crohn's_disease", "C", "U")


i <- individual[disease == "C"]
designPalmieriC <- model.matrix(~ 0  + tissue[disease == "C"]
                                + i)
colnames(designPalmieriC)[1:2] <- c("I", "nI")


contrastMatrixC <- makeContrasts(I-nI, levels = designPalmieriC)

PalmieriFitC <- eBayes(contrasts.fit(lmFit(PalmieriFinal[,disease == "C"],
                                design = designPalmieriC),
                                contrastMatrixC))
tableC <-  topTable(PalmieriFitC, number = Inf)
write.csv(tableC, file = "tableC.csv")

rm(tableC)

tableC <- read.csv("tableC.csv", row.names  = 1)
DEgenesCD <- base::subset(tableC, adj.P.Val < 0.1)$PROBEID

message(paste0(as.character(DEgenesCD)[1:5], collapse = "--"))


#DEgenesCD <- rownames(subset(tableC, adj.P.Val < 0.05))


#load("testDataGeneFinder.RData")

#backGIdx <- genefinder(PalmieriFinal, DEgenesCD, 5)


# backGIdx <- genefinder(as.matrix(tableC[, "AveExpr", drop = F]), 
#                         match(DEgenesCD, rownames(tableC)), 5,
#    method="manhattan", scale="none")

#backGIdx <- sapply(backGIdx, function(x)x$indices)

#backGIdx <- backGIdx[is.finite(backGIdx)]

#backG <-featureNames(PalmieriFinal)[backGIdx]
# backG <- setdiff(backG, DEgenesCD)
# length(backG)
# 
#   multidensity( list(
#        all=  tableC[,"AveExpr"] ,
#        fore= tableC[DEgenesCD, "AveExpr"],
#        back= tableC[rownames(tableC) %in% backG, "AveExpr"]),
#      xlab="mean expression",
#   main = "DE genes for CD - Background - Matching")
```






